{
  "info": {
    "name": "Echo (Newman) - Auth flow",
    "_postman_id": "11111111-1111-1111-1111-111111111111",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://127.0.0.1:5001"
    },
    {
      "key": "username",
      "value": ""
    },
    {
      "key": "email",
      "value": ""
    },
    {
      "key": "password",
      "value": ""
    },
    {
      "key": "echoText",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "1) POST /register (expect 302 redirect)",
      "protocolProfileBehavior": {
        "followRedirects": false
      },
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "display_name",
              "value": "Newman User",
              "type": "text"
            },
            {
              "key": "username",
              "value": "",
              "type": "text"
            },
            {
              "key": "email",
              "value": "",
              "type": "text"
            },
            {
              "key": "password",
              "value": "",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{baseUrl}}/register",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "register"
          ]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const stamp = Date.now();",
              "const username = `newman_user_${stamp}`;",
              "const email = `newman_user_${stamp}@example.com`;",
              "const password = 'TestPassword123';",
              "const echoText = `Newman Echo ${stamp}`;",
              "",
              "pm.collectionVariables.set('username', username);",
              "pm.collectionVariables.set('email', email);",
              "pm.collectionVariables.set('password', password);",
              "pm.collectionVariables.set('echoText', echoText);",
              "",
              "pm.request.body.urlencoded.find(x => x.key === 'username').value = username;",
              "pm.request.body.urlencoded.find(x => x.key === 'email').value = email;",
              "pm.request.body.urlencoded.find(x => x.key === 'password').value = password;"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status is 302 (redirect)', function () {",
              "  pm.expect(pm.response.code).to.eql(302);",
              "});",
              "",
              "pm.test('Has Location header', function () {",
              "  pm.expect(pm.response.headers.has('Location')).to.be.true;",
              "});",
              "",
              "pm.test('Redirects to /dashboard (or includes it)', function () {",
              "  const loc = pm.response.headers.get('Location') || '';",
              "  pm.expect(loc).to.include('/dashboard');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "2) POST /create_echo (expect 302 redirect)",
      "protocolProfileBehavior": {
        "followRedirects": false
      },
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "echo",
              "value": "{{echoText}}",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{baseUrl}}/create_echo",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "create_echo"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status is 302 (redirect)', function () {",
              "  pm.expect(pm.response.code).to.eql(302);",
              "});",
              "",
              "pm.test('Has Location header', function () {",
              "  pm.expect(pm.response.headers.has('Location')).to.be.true;",
              "});",
              "",
              "pm.test('Redirects to /dashboard (or includes it)', function () {",
              "  const loc = pm.response.headers.get('Location') || '';",
              "  pm.expect(loc).to.include('/dashboard');",
              "});",
              "",
              "// Spara postId f√∂r edit/delete-stegen",
              "const loc = pm.response.headers.get('Location') || '';",
              "const match = loc.match(/\\/echo\\/(\\d+)/);",
              "if (match) {",
              "  pm.collectionVariables.set('postId', match[1]);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "3) GET /dashboard (verify echo exists in HTML)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/dashboard",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "dashboard"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () {",
              "  pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response is HTML', function () {",
              "  const ct = pm.response.headers.get('Content-Type') || '';",
              "  pm.expect(ct.toLowerCase()).to.include('text/html');",
              "});",
              "",
              "pm.test('Dashboard contains the created echo text', function () {",
              "  const echoText = pm.collectionVariables.get('echoText');",
              "  pm.expect(pm.response.text()).to.include(echoText);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "4) POST /edit_echo/:id (expect 302 redirect)",
      "protocolProfileBehavior": {
        "followRedirects": false
      },
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "echo",
              "value": "Updated {{echoText}}",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{baseUrl}}/edit_echo/{{postId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "edit_echo",
            "{{postId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status is 302 (redirect)', function () {",
              "  pm.expect(pm.response.code).to.eql(302);",
              "});",
              "",
              "pm.test('Redirects to /dashboard', function () {",
              "  const loc = pm.response.headers.get('Location') || '';",
              "  pm.expect(loc).to.include('/dashboard');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "5) POST /delete_echo/:id (expect 302 redirect)",
      "protocolProfileBehavior": {
        "followRedirects": false
      },
      "request": {
        "method": "POST",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/delete_echo/{{postId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "delete_echo",
            "{{postId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status is 302 (redirect)', function () {",
              "  pm.expect(pm.response.code).to.eql(302);",
              "});",
              "",
              "pm.test('Redirects to /dashboard', function () {",
              "  const loc = pm.response.headers.get('Location') || '';",
              "  pm.expect(loc).to.include('/dashboard');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "6) GET /api/profile/:username (expect 200)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/profile/{{username}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "profile",
            "{{username}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () {",
              "  pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Contains username', function () {",
              "  const json = pm.response.json();",
              "  pm.expect(json.username).to.eql(pm.collectionVariables.get('username'));",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "7) PUT /api/profile (expect 200)",
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"display_name\": \"Updated Newman User\",\n  \"bio\": \"Updated by Newman API test\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/profile",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "profile"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status 200', function () {",
              "  pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Update success true', function () {",
              "  const json = pm.response.json();",
              "  pm.expect(json.success).to.eql(true);",
              "});"
            ]
          }
        }
      ]
    }
  ]
}